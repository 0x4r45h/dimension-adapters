import BigNumber from "bignumber.js";
import request, { gql } from "graphql-request";
import { FetchOptions, SimpleAdapter } from "../../adapters/types";
import { CHAIN } from "../../helpers/chains";

const endpoint =
  "https://api.goldsky.com/api/public/project_cm0qvthsz96sp01utcnk55ib0/subgraphs/filament-sei/v3/gn";

// Get timestamps for yesterday and today
const now = Math.floor(Date.now() / 1000); // Current timestamp in seconds
const yesterday = now - 86400; // 24 hours ago

const queryDaily = gql`
  query stats($yesterday: Int!, $now: Int!) {
    totalTradingFees(
      orderBy: block_number
      orderDirection: asc
      where: { timestamp__gte: $yesterday, timestamp__lte: $now }
    ) {
      timestamp_
      block_number
      account
      totalFees
    }
  }
`;

// Removed the hardcoded timestamp to fetch ALL fees
const queryTotal = gql`
  query stats {
    totalTradingFees(orderBy: block_number, orderDirection: asc) {
      timestamp_
      block_number
      account
      totalFees
    }
  }
`;

interface IGraphResponse {
  totalTradingFees: Array<{
    timestamp_: string;
    block_number: string;
    account: string;
    totalFees: string;
  }>;
}

const methodology = {
  totalFees:
    "Tracks the cumulative fees (borrowing fees + trading fees) generated by all transactions.",
  dailyFees:
    "Tracks the fees (borrowing fees + trading fees) generated by transactions on a daily basis.",
};

const toString = (x: BigNumber) => {
  if (x.isEqualTo(0)) return undefined;
  return x.toString();
};

const fetchProtocolFees = async () => {
  // Fetch daily fees
  console.log("Now", now);
  const yesterday = now - 86400; // 24 hours ago
  console.log("Yesterday", yesterday);

  const responseDaily: IGraphResponse = await request(endpoint, queryDaily, {
    yesterday,
    now,
  });

  let dailyFees = new BigNumber(0);
  responseDaily.totalTradingFees.forEach((dailyData) => {
    dailyFees = dailyFees.plus(new BigNumber(dailyData.totalFees));
  });

  // Fetch total fees without time constraints
  const responseTotal: IGraphResponse = await request(endpoint, queryTotal);

  let totalFees = new BigNumber(0);
  responseTotal.totalTradingFees.forEach((totalData) => {
    totalFees = totalFees.plus(new BigNumber(totalData.totalFees));
  });

  console.log("Daily Fees Raw", toString(dailyFees));
  console.log("Total Fees Raw", toString(totalFees));

  // Validate that total fees are greater than or equal to daily fees
  if (totalFees.isLessThan(dailyFees)) {
    console.error(
      "Error: Total fees are less than daily fees. This is logically impossible."
    );
    console.log(
      "Setting total fees to at least daily fees to maintain data consistency"
    );
    totalFees = BigNumber.max(totalFees, dailyFees);
  }

  dailyFees = dailyFees.dividedBy(new BigNumber(1e18));
  totalFees = totalFees.dividedBy(new BigNumber(1e18));

  const _dailyFees = toString(dailyFees);
  const _totalFees = toString(totalFees);

  return {
    dailyFees: _dailyFees ?? "0",
    totalFees: _totalFees ?? "0",
  };
};

const adapter: SimpleAdapter = {
  adapter: {
    [CHAIN.SEI]: {
      fetch: fetchProtocolFees,
      start: "2025-01-21",
      meta: {
        methodology,
      },
    },
  },
};

export default adapter;
